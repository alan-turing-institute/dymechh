#### Resampling the HADs grid
## As the UKCP18 2.2km historic projections (needed for recal) just run from 1980-2000, regridding these daily observations from the 1km available via HADs
## Hads data from CEDA, Readme file for the data available in vmfileshare/ClimateData/HadUKData
## HADs data is on a 1 km grid OSGB projection (so should be the same as teh reprojected UKCD files )

#directory of climate var 
dd <- paste0("/mnt/vmfileshare/ClimateData/Raw/HadsUKgrid/tasmax/")
HAD.tmax <- list.files(dd)

HAD.allpaths <- paste0(dd, HAD.tmax)
HAD.tmax.all.files <- HAD.allpaths[grepl("*.nc$", HAD.allpaths)] #744 files 

##For recalibration, only need years 1980-2000 
s <- paste0("day_",1981:2000, collapse="|")
HAD.tmax.slice1 <- HAD.tmax.all.files[grepl(s, HAD.tmax.all.files)] 

#One brick for each year 
HADbrickL <- lapply(HAD.tmax.slice1, brick)

#HADbrickL is a list of 240 bricks
#Each brick represents a month, with each raster layer within each brick representing the Hads grid for a day 

#Confirming numbers are correct
##length(HADbrickL)
##HB1 <- HADbrickL[[25]]
##nlayers(HB1)

#To get the correct extent (ie the sames as above in UKCD, rather than the MSOA group extent) going to first create the grid frame which is used for the reprojection of Hads data, and then use this total extent to crop Hads


#### Create Grid from UKCP data 

#Extract the 2.2km grid from the UK raster and then overlay that and create the mean from HADs

#Using a random cropped raster to the prototypic extent create the grid then average everything on the same long/lats as before
r <- Run4Y1$tasmax_rcp85_land.cpm_uk_2.2km_06_day_19881201.19891130_1
grid <- as(r,'SpatialPolygonsDataFrame')

e2 <- extent(grid@bbox)
e2 <- as(e2,"SpatialPolygons")

#Name the bricks for easier merging
HAD_months <- sapply(1981:2000, function(y){paste0("Hads",y,"_", 01:12)})
names(HADbrickL) <- HAD_months

#Crop HADs as with UKCD files -not necessary if running on whole of UK
HADbrickL_crop <- lapply(HADbrickL, function(x){crop(x, e2, snap="out")})

#Returns list of bricks, where each brick represents the year of daily Hads observation for the calibration period. This is to make it easier later to align to UKCP
HADbrickL_crop_Y <- lapply(1981:2000, function(Y){
  tobrick <- HADbrickL_crop[grepl(paste0("Hads",Y),names(HADbrickL_crop))]
  b <- brick(tobrick)
})

names(HADbrickL_crop_Y)<- paste0("Y", 1981:2000)


#### Resample HADS data to UKCP grid 


#Resample -- Transfer values of a SpatRaster to another one with a different geometry
r <- Run4Y1$tasmax_rcp85_land.cpm_uk_2.2km_06_day_19881201.19891130_1 #Random day as before - just using for the geometry

HADbrickL_crop_Y_2.2km <- lapply(HADbrickL_crop_Y, function(x){
  terra::resample(x, r, method="bilinear")}) #Bilinear resampling appropriate for continious vars 

